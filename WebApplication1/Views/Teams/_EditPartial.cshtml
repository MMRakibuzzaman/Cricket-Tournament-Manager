@using WebApplication1.Models
@model WebApplication1.Models.ViewModels.TeamMasterDetailVM

<form asp-action="Edit" method="post" enctype="multipart/form-data">
    <input type="hidden" asp-for="TeamId" />

    <div class="modal-body">

        <h5 class="mb-3 text-primary border-bottom pb-2">Edit Team Details</h5>

        <div class="row g-3 mb-4">
            <div class="col-md-8">
                <div class="form-floating">
                    <input asp-for="Name" class="form-control" placeholder="Team Name" />
                    <label asp-for="Name"></label>
                    <span asp-validation-for="Name" class="text-danger"></span>
                </div>
            </div>
            <div class="col-md-4">
                @if (!string.IsNullOrEmpty(Model.CurrentLogoUrl))
                {
                    <div class="d-flex align-items-center mb-1">
                        <img src="@Model.CurrentLogoUrl" width="30" height="30" class="rounded-circle border me-2" />
                        <span class="small text-muted">Current</span>
                    </div>
                }
                <input asp-for="LogoFile" class="form-control form-control-sm" type="file" />
            </div>

            <div class="col-md-4">
                <div class="form-floating">
                    <input asp-for="Revenue" class="form-control" type="number" step="0.01" />
                    <label asp-for="Revenue"></label>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-floating">
                    <input asp-for="EstablishedDate" class="form-control" type="date" />
                    <label asp-for="EstablishedDate"></label>
                </div>
            </div>
            <div class="col-md-4 d-flex align-items-center">
                <div class="form-check form-switch p-2 border rounded w-100">
                    <input class="form-check-input ms-2" type="checkbox" asp-for="IsActive" />
                    <label class="form-check-label fw-bold ms-2" asp-for="IsActive">Active</label>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0 text-secondary border-bottom pb-2">Player Manager</h5>
            <button type="button" class="btn btn-sm btn-outline-success" id="btnAddRowEdit">
                <i class="fa-solid fa-plus"></i> Add Player
            </button>
        </div>

        <div class="table-responsive bg-light border rounded" style="max-height: 350px; overflow-y: auto;">
            <table class="table table-sm table-hover mb-0">
                <thead class="text-muted small sticky-top bg-light">
                    <tr>
                        <th style="width: 40%">Full Name</th>
                        <th style="width: 30%">Role</th>
                        <th style="width: 25%">Date of Birth</th>
                        <th style="width: 5%"></th>
                    </tr>
                </thead>
                <tbody id="editRosterBody">
                    @for (int i = 0; i < Model.Players.Count; i++)
                    {
                        <tr id="player-row-@Model.Players[i].PlayerId">
                            <input type="hidden" name="Players[@i].PlayerId" value="@Model.Players[i].PlayerId" />

                            <td>
                                <input name="Players[@i].FullName" value="@Model.Players[i].FullName" class="form-control form-control-sm" placeholder="Name" />
                            </td>
                            <td>
                                <select name="Players[@i].Role" class="form-select form-select-sm" asp-items="Html.GetEnumSelectList<PlayerRole>()" asp-for="@Model.Players[i].Role"></select>
                            </td>
                            <td>
                                <input name="Players[@i].DateOfBirth" type="date" class="form-control form-control-sm"
                                       value="@(Model.Players[i].DateOfBirth?.ToString("yyyy-MM-dd"))" />
                            </td>
                            <td class="text-end">
                                @if (Model.Players[i].PlayerId > 0)
                                {
                                    <button type="button" class="btn btn-link text-danger btn-sm p-0"
                                            onclick="if(confirm('Remove this player permanently?')) { deletePlayerRow(@Model.Players[i].PlayerId); }">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                }
                                else
                                {
                                    <button type="button" class="btn btn-link text-danger btn-sm p-0 remove-new-row">
                                        <i class="fa-solid fa-times"></i>
                                    </button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal-footer d-flex justify-content-between align-items-center mt-2">
        <button type="button" class="btn btn-outline-danger"
                onclick="if(confirm('Are you sure? This will delete the Team AND all its Players!')) { deleteItem('@Url.Action("Delete", "Teams", new { id = Model.TeamId })'); }">
            <i class="fa-solid fa-trash-can"></i> Delete Team
        </button>

        <div>
            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="offcanvas">Cancel</button>
            <button type="submit" class="btn btn-primary px-4">Save Changes</button>
        </div>
    </div>
</form>
<script>
    document.getElementById('btnAddRowEdit').addEventListener('click', function() {
        var tbody = document.getElementById('editRosterBody');
        var rowCount = tbody.rows.length;
        var row = tbody.insertRow(-1);

        row.innerHTML += `<input type="hidden" name="Players[${rowCount}].PlayerId" value="0" />`;

        var cell1 = row.insertCell(0);
        cell1.innerHTML = `<input name="Players[${rowCount}].FullName" class="form-control form-control-sm" placeholder="New Player" />`;

        var cell2 = row.insertCell(1);
        var selectTemplate = document.querySelector('#editRosterBody select');
        var options = selectTemplate ? selectTemplate.innerHTML : '';
        cell2.innerHTML = `<select name="Players[${rowCount}].Role" class="form-select form-select-sm">${options}</select>`;

        var cell3 = row.insertCell(2);
        cell3.innerHTML = `<input name="Players[${rowCount}].DateOfBirth" type="date" class="form-control form-control-sm" />`;

        var cell4 = row.insertCell(3);
        cell4.className = "text-end";
        cell4.innerHTML = `<button type="button" class="btn btn-link text-danger btn-sm p-0 remove-new-row"><i class="fa-solid fa-times"></i></button>`;
    });

    document.getElementById('editRosterBody').addEventListener('click', function(e) {
        if (e.target.closest('.remove-new-row')) {
            e.target.closest('tr').remove();
        }
    });

    function deletePlayerRow(playerId) {
        $.post('@Url.Action("DeletePlayer", "Teams")/' + playerId, function(res) {
            if(res.success) {
                var row = document.getElementById('player-row-' + playerId);
                if(row) row.remove();
            } else {
                alert("Could not remove player.");
            }
        });
    }
</script>